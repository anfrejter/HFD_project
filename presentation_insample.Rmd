---
title: "Quantitative strategies on High Frequency Data"
subtitle: "submission of research project -- SAMPLE PRESENTATION"
author: "Team members: Author nr 1 and Author nr 2"
date: "academic year 2024/2025"
output: ioslides_presentation
fontsize: 12pt
---

## Supporting code

### Utils

```{r, echo = F, warning = F, message = F}
# UTILS
library(xts)
library(chron)
library(TTR)
library(tseries)

mySR <- function(x, scale) {
  sqrt(scale) * mean(coredata(x), na.rm = TRUE) /
    sd(coredata(x), na.rm = TRUE)
}

myCalmarRatio <- function(x, scale) {
  scale * mean(coredata(x), na.rm = TRUE) /
    maxdrawdown(cumsum(x))$maxdrawdown
}

get_statistics <- function(gross, net, scale = 252, add_info = FALSE) {

  all_gross_zeros <- all(gross == 0)
  all_net_zeros <- all(net == 0)

  netCR <- if (all_net_zeros) 0 else myCalmarRatio(net, scale)

  if (add_info) {

    grossSR <- if (all_gross_zeros) 0 else mySR(gross, scale)
    grossCR <- if (all_gross_zeros) 0 else myCalmarRatio(gross, scale)
    netSR <- if (all_net_zeros) 0 else mySR(net, scale)
    stat_ <- if (all_net_zeros) 0 else netCR * max(0, log(abs(sum(net) / 1000)))

    return(data.frame(
      grossSR = grossSR,
      netSR = netSR,
      grossCR = grossCR,
      netCR = netCR,
      stat = stat_
    ))
  } else {

    stat_ <- if (all_net_zeros) 0 else netCR * max(0, log(abs(sum(net) / 1000)))
    return(stat_)
  }
}

get_pos_flat <- function(data, group = 1) {
  pos_flat <- xts(x = rep(0, length(index(data))), order.by = index(data))
  names(pos_flat) <- "pos_flat"
  if (group == 1) {
    pos_flat["/T9:55"] <- 1
    pos_flat["T15:40/"] <- 1
  }
  if (group == 2) {
    pos_flat["T16:50/18:10"] <- 1
  }
  return(pos_flat)
}

get_pnl <- function(positions, prices, p_val, tr_cost, add_info = FALSE) {

  positions[is.na(positions)] <- 0
  pnl_gross <- positions * diff.xts(prices) * p_val
  pnl_gross[is.na(pnl_gross)] <- 0
  n_trans <- abs(diff.xts(positions))
  n_trans[1] <- 0
  pnl_net <- pnl_gross - n_trans * tr_cost
  pnl_net[is.na(pnl_net)] <- 0

  # aggregate to daily
  my.endpoints <- endpoints(prices, "days")
  daily_pnl_gross <- period.apply(pnl_gross,
    INDEX = my.endpoints,
    FUN = function(x) sum(x, na.rm = TRUE)
  )
  daily_pnl_net <- period.apply(pnl_net,
    INDEX = my.endpoints,
    FUN = function(x) sum(x, na.rm = TRUE)
  )

  if (add_info) {
    result_xts <- cbind(
      daily_pnl_gross, daily_pnl_net,
      pnl_gross, pnl_net,
      n_trans
    )
    colnames(result_xts) <- c(
      "daily_pnl_gross", "daily_pnl_net",
      "pnl_gross", "pnl_net", "n_trans"
    )

    return(result_xts)
  } else {
    result_xts <- cbind(
      daily_pnl_gross, daily_pnl_net
    )
    colnames(result_xts) <- c(
      "daily_pnl_gross", "daily_pnl_net"
    )
    return(result_xts)
  }
}

```

### Plots

```{r, echo = F, warning = F, message = F}
# PLOTS
library(ggplot2)
library(ggthemes)
library(reshape2)
library(dplyr) # Ensure dplyr is loaded

plot_ma_ggplot <- function(prices, slow_m, fast_m, position, date) {

  df <- data.frame(
    index(prices[date]),
    prices[date],
    slow_m[date],
    fast_m[date],
    position[date]
  )
  names(df) <- c("Index", "prices", "slow_m", "fast_m", "position")

  df$position_group <- ifelse(df$position == 1, "Long",
    ifelse(df$position == -1, "Short", "Flat")
  )

  p <- ggplot(df, aes(x = Index)) +
    geom_rect(aes(
      xmin = Index, xmax = dplyr::lead(Index, default = last(Index)),
      ymin = -Inf, ymax = Inf, fill = position_group
    ), alpha = 0.2) +

    geom_line(aes(y = prices, color = "Price", ), linewidth = 1) +
    geom_line(aes(y = slow_m, color = "Slow MA", linetype = "Slow MA"),
              linewidth = 1) +
    geom_line(aes(y = fast_m, color = "Fast MA", linetype = "Fast MA"),
              linewidth = 1) +
    scale_color_manual(values = c(
      "Price" = "#1b1b1b",
      "Slow MA" = "#377eb8",
      "Fast MA" = "#e41a1c"
    )) +
    scale_linetype_manual(values = c(
      "Price" = "solid",
      "Slow MA" = "dashed",
      "Fast MA" = "dashed"
    )) +
    scale_fill_manual(values = c(
      "Long" = "#4daf4a",
      "Short" = "#ff7f00",
      "Flat" = "#999999"
    )) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5, color = "#333333"),
      axis.title = element_text(face = "bold", color = "#333333"),
      legend.position = "top",
      legend.box = "horizontal"
    ) +
    labs(
      title = "MA strategy",
      x = "Time", y = "Value",
      color = "Legend", fill = "Position"
    )

  return(p)
}

plot_2vb_ggplot <- function(prices, signal, exit_lower,
                            exit_upper, entry_lower,
                            entry_upper, position, date) {

  df <- data.frame(
    Index = index(prices[date]),
    prices = prices[date],
    signal = signal[date],
    exit_lower = exit_lower[date],
    exit_upper = exit_upper[date],
    entry_lower = entry_lower[date],
    entry_upper = entry_upper[date],
    position = position[date]
  )

  names(df) <- c("Index", "prices", "signal", "exit_lower", "exit_upper",
                 "entry_lower", "entry_upper", "position")

  df$position_group <- ifelse(df$position == 1, "Long",
                        ifelse(df$position == -1, "Short", "Flat"))

  p <- ggplot(df, aes(x = Index)) +
    geom_rect(aes(
      xmin = Index, xmax = dplyr::lead(Index, default = last(Index)),
      ymin = -Inf, ymax = Inf, fill = position_group
    ), alpha = 0.2) +
    geom_line(aes(y = prices, color = "Price"), linewidth = 1) +
    geom_line(aes(y = signal, color = "Signal"), linewidth = 1) +

    geom_line(aes(y = exit_lower, color = "Exit Lower",
                  linetype = "Exit Lower"),
              linewidth = 1) +
    geom_line(aes(y = exit_upper, color = "Exit Upper",
                  linetype = "Exit Upper"),
              linewidth = 1) +
    geom_line(aes(y = entry_lower, color = "Entry Lower",
                  linetype = "Entry Lower"),
              linewidth = 1) +
    geom_line(aes(y = entry_upper, color = "Entry Upper",
                  linetype = "Entry Upper"),
              linewidth = 1) +

    scale_color_manual(values = c(
      "Price" = "#1b1b1b",
      "Signal" = "#984ea3",
      "Exit Lower" = "#377eb8",
      "Exit Upper" = "#377eb8",
      "Entry Lower" = "#e41a1c",
      "Entry Upper" = "#e41a1c"
    )) +
    scale_linetype_manual(values = c(
      "Exit Lower" = "dashed",
      "Exit Upper" = "dashed",
      "Entry Lower" = "dotted",
      "Entry Upper" = "dotted"
    )) +
    scale_fill_manual(values = c(
      "Long" = "#4daf4a",
      "Short" = "#ff7f00",
      "Flat" = "#999999"
    )) +

    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5, color = "#333333"),
      axis.title = element_text(face = "bold", color = "#333333"),
      legend.position = "top",
      legend.box = "horizontal"
    ) +

    labs(
      title = "Double Volatility Breakout Strategy",
      x = "Time", y = "Value",
      color = "Signal", fill = "Position"
    )
  return(p)
}

```

### Strategies

```{r, echo = F, warning = F, message = F}
# STRATEGIES

library(xts)
library(roll)
library(quantmod)
library(TTR)
source("https://raw.githubusercontent.com/ptwojcik/HFD/master/function_positionVB_new.R")
source("helpers/utils.R")

get_regime <- function(prices, window, type = "corr", treshold = 0.2) {
  if (type == "corr") {
    # rolling correlation between prices and lagged prices,
    # High positive autocorrelation in short-term returns suggests momentum,
    # while negative autocorrelation suggests mean reversion.
    valid_rows <- !is.na(prices) & !is.na(lag.xts(prices, 2))
    data_clean <- prices[valid_rows]
    # runCor takes ts series without nans (nonleading)
    corr_ <- runCor(
      y = lag.xts(data_clean), x = lag.xts(data_clean, 2),
      n = window
    )
    corr_all <- merge(prices, corr_)$corr_
    regime <- ifelse(abs(corr_all) <= treshold, 0, ifelse(corr_all > 0, 1, -1))
  } else if (type == "var_ratio") {
    # rolling variance ratio
    # The variance ratio is the ratio of the variance of the returns over different time horizons.
    # A variance ratio greater than 1 suggests momentum, while a ratio less than 1 suggests mean reversion.
    var_ratio_ <- roll_var(
      x = lag.xts(prices), n = window
    ) / roll_var(
      x = lag.xts(prices, 2), n = window + diff_window
    )
    regime <- ifelse(var_ratio_ <= treshold, 0, ifelse(var_ratio_ > 1, 1, -1))
  }
  return(regime)
}

get_pnl_ma <- function(prices, group = 1,
                       slow_param, fast_param,
                       p_val, tr_cost,
                       signal_estimator = "mean",
                       window_regime = 20,
                       treshold_regime = 0.2,
                       scale_ = 252,
                       add_info = FALSE,
                       add_stats = FALSE) {
  if (group == 1) {
    prices["/T9:40"] <- NA
    prices["T15:50/"] <- NA
  }
  pos_flat <- get_pos_flat(prices, group)

  if (signal_estimator == "mean") {
    slow_m <- roll_mean(prices, slow_param)
    fast_m <- roll_mean(prices, fast_param)
  } else if (signal_estimator == "median") {
    slow_m <- roll_median(prices, slow_param)
    fast_m <- roll_median(prices, fast_param)
  }


  slow_m[is.na(prices)] <- NA
  fast_m[is.na(prices)] <- NA

  # position momentum
  pos_mm <- ifelse(pos_flat != 1,
    ifelse(lag.xts(fast_m) > lag.xts(slow_m), 1, -1), 0
  )
  pos_mm[is.na(pos_mm)] <- 0

  pos_mr <- -pos_mm
  mom_regime <- get_regime(prices, window = window_regime, treshold = treshold_regime)
  pos_fl <- ifelse(mom_regime == 1, pos_mm, pos_mr)
  pos_fl[is.na(prices)] <- 0

  results_mm <- get_pnl(pos_mm, prices, p_val, tr_cost, add_info = add_info)
  results_mr <- get_pnl(pos_mr, prices, p_val, tr_cost, add_info = add_info)
  results_fl <- get_pnl(pos_fl, prices, p_val, tr_cost, add_info = add_info)

  if (add_info) {
    result_xts <- cbind(
      prices, pos_flat, slow_m, fast_m,
      pos_mm, pos_mr, pos_fl,
      results_mm$pnl_gross, results_mm$pnl_net, results_mm$n_trans,
      results_mr$pnl_gross, results_mr$pnl_net, results_mr$n_trans,
      results_fl$pnl_gross, results_fl$pnl_net, results_fl$n_trans,
      fill = NA
    )
    colnames(result_xts) <- c(
      "prices", "pos_flat", "slow_m", "fast_m",
      "pos_mm", "pos_mr", "pos_fl",
      "pnl_gross_mm", "pnl_net_mm", "n_trans_mm",
      "pnl_gross_mr", "pnl_net_mr", "n_trans_mr",
      "pnl_gross_fl", "pnl_net_fl", "n_trans_fl"
    )
    return(result_xts)
  } else {

    stats_mm <- get_statistics(results_mm$daily_pnl_gross,
      results_mm$daily_pnl_net,
      scale = scale_, add_info = add_stats
    )
    stats_mr <- get_statistics(results_mr$daily_pnl_gross,
      results_mr$daily_pnl_net,
      scale = scale_, add_info = add_stats
    )
    stats_fl <- get_statistics(results_fl$daily_pnl_gross,
      results_fl$daily_pnl_net,
      scale = scale_, add_info = add_stats
    )

    return(cbind(stats_mm, stats_mr, stats_fl))
  }
}

get_pnl_vb <- function(prices, group = 1,
                       slow_param, fast_param,
                       volat_param, m_,
                       p_val, tr_cost,
                       signal_estimator = "mean",
                       window_regime = 20,
                       treshold_regime = 0.2,
                       scale_ = 252,
                       add_info = FALSE,
                       add_stats = FALSE) {
  if (group == 1) {
    prices["/T9:40"] <- NA
    prices["T15:50/"] <- NA
  }
  pos_flat <- get_pos_flat(prices, group)

  if (signal_estimator == "mean") {
    slow_m <- roll_mean(prices, slow_param)
    fast_m <- roll_mean(prices, fast_param)
  } else if (signal_estimator == "median") {
    slow_m <- roll_median(prices, slow_param)
    fast_m <- roll_median(prices, fast_param)
  }

  volat_sd <- roll_sd(prices, volat_param)

  slow_m[is.na(prices)] <- NA
  fast_m[is.na(prices)] <- NA
  volat_sd[is.na(prices)] <- NA

  pos_mm <- positionVB_new(
    signal = fast_m,
    lower = slow_m - m_ * volat_sd,
    upper = slow_m + m_ * volat_sd,
    pos_flat = pos_flat,
    strategy = "mom"
  )

  pos_mm[is.na(pos_mm)] <- 0
  pos_mr <- -pos_mm

  mom_regime <- get_regime(prices, window = window_regime, treshold = treshold_regime)
  pos_fl <- ifelse(mom_regime == 1, pos_mm, pos_mr)
  pos_fl[is.na(prices)] <- 0

  results_mm <- get_pnl(pos_mm, prices, p_val, tr_cost, add_info = add_info)
  results_mr <- get_pnl(pos_mr, prices, p_val, tr_cost, add_info = add_info)
  results_fl <- get_pnl(pos_fl, prices, p_val, tr_cost, add_info = add_info)

  results_mm <- get_pnl(pos_mm, prices, p_val, tr_cost, add_info = add_info)
  results_mr <- get_pnl(pos_mr, prices, p_val, tr_cost, add_info = add_info)

  results_mm <- get_pnl(pos_mm, prices, p_val, tr_cost, add_info = add_info)
  results_mr <- get_pnl(pos_mr, prices, p_val, tr_cost, add_info = add_info)
  results_fl <- get_pnl(pos_fl, prices, p_val, tr_cost, add_info = add_info)

  if (add_info) {
    result_xts <- cbind(
      prices, pos_flat, slow_m, fast_m, volat_sd,
      pos_mm, pos_mr, pos_fl,
      results_mm$pnl_gross, results_mm$pnl_net, results_mm$n_trans,
      results_mr$pnl_gross, results_mr$pnl_net, results_mr$n_trans,
      results_fl$pnl_gross, results_fl$pnl_net, results_fl$n_trans,
      fill = NA
    )
    colnames(result_xts) <- c(
      "prices", "pos_flat", "slow_m", "fast_m", "volat_sd",
      "pos_mm", "pos_mr", "pos_fl",
      "pnl_gross_mm", "pnl_net_mm", "n_trans_mm",
      "pnl_gross_mr", "pnl_net_mr", "n_trans_mr",
      "pnl_gross_fl", "pnl_net_fl", "n_trans_fl"
    )
    return(result_xts)
  } else {
    stats_mm <- get_statistics(results_mm$daily_pnl_gross,
      results_mm$daily_pnl_net,
      scale = scale_, add_info = add_stats
    )
    stats_mr <- get_statistics(results_mr$daily_pnl_gross,
      results_mr$daily_pnl_net,
      scale = scale_, add_info = add_stats
    )
    stats_fl <- get_statistics(results_fl$daily_pnl_gross,
      results_fl$daily_pnl_net,
      scale = scale_, add_info = add_stats
    )
    return(cbind(stats_mm, stats_mr, stats_fl))
  }
}

position_2VB <- function(signal,
                         exit_lower,
                         exit_upper,
                         entry_lower,
                         entry_upper,
                         pos_flat,
                         strategy = "mom") {
  signal <- coredata(signal)
  exit_lower <- coredata(exit_lower)
  exit_upper <- coredata(exit_upper)
  entry_lower <- coredata(entry_lower)
  entry_upper <- coredata(entry_upper)
  time_index <- index(signal)
  position <- rep(0, length(signal))
  pos_flat <- coredata(pos_flat)

  for (i in 2:length(signal)) {
    if (pos_flat[i] == 1) {
      position[i] <- 0
    } else {
      if (!is.na(signal[i - 1]) &&
        !is.na(exit_lower[i - 1]) &&
        !is.na(exit_upper[i - 1]) &&
        !is.na(entry_lower[i - 1]) &&
        !is.na(entry_upper[i - 1])
      ) {
        if (position[i - 1] == 0) {
          if (signal[i - 1] > entry_upper[i - 1]) {
            position[i] <- 1
          }
          if (signal[i - 1] < entry_lower[i - 1]) {
            position[i] <- -1
          }
        } else if (position[i - 1] == 1) {
          if (signal[i - 1] > exit_lower[i - 1]) {
            position[i] <- 1
          }
          if ((signal[i - 1] < exit_lower[i - 1]) &&
            (signal[i - 1] > entry_lower[i - 1])) {
            position[i] <- 0
          }
          if (signal[i - 1] < entry_lower[i - 1]) {
            position[i] <- -1
          }
        } else if (position[i - 1] == -1) {
          if (signal[i - 1] < exit_upper[i - 1]) {
            position[i] <- -1
          }
          if ((signal[i - 1] > exit_upper[i - 1]) &&
            (signal[i - 1] < entry_upper[i - 1])) {
            position[i] <- 0
          }
          if (signal[i - 1] > entry_upper[i - 1]) {
            position[i] <- 1
          }
        } else {
          position[i] <- position[i - 1]
        }
      }
    }
  }
  if (strategy == "mom") {
    return(position)
  } else if (strategy == "mr") {
    return(-position)
  }
}

get_pnl_2vb <- function(prices, group = 1,
                        slow_param, fast_param,
                        volat_param, m_entry, m_exit,
                        p_val, tr_cost,
                        signal_estimator = "mean",
                        window_regime = 20,
                        treshold_regime = 0.2,
                        scale_ = 252,
                        add_info = FALSE,
                        add_stats = FALSE) {
  if (group == 1) {
    prices["/T9:40"] <- NA
    prices["T15:50/"] <- NA
  }
  pos_flat <- get_pos_flat(prices, group)

  if (signal_estimator == "mean") {
    slow_m <- roll_mean(prices, slow_param)
    fast_m <- roll_mean(prices, fast_param)
  } else if (signal_estimator == "median") {
    slow_m <- roll_median(prices, slow_param)
    fast_m <- roll_median(prices, fast_param)
  }
  volat_sd <- roll_sd(prices, volat_param)

  slow_m[is.na(prices)] <- NA
  fast_m[is.na(prices)] <- NA
  volat_sd[is.na(prices)] <- NA

  exit_lower <- slow_m - m_exit * volat_sd
  exit_upper <- slow_m + m_exit * volat_sd
  entry_lower <- slow_m - m_entry * volat_sd
  entry_upper <- slow_m + m_entry * volat_sd

  pos_mm <- position_2VB(
    signal = fast_m,
    exit_lower = exit_lower,
    exit_upper = exit_upper,
    entry_lower = entry_lower,
    entry_upper = entry_upper,
    pos_flat = pos_flat,
    strategy = "mom"
  )

  pos_mm[is.na(pos_mm)] <- 0
  pos_mr <- -pos_mm

  mom_regime <- get_regime(prices, window = window_regime, treshold = treshold_regime)
  pos_fl <- ifelse(mom_regime == 1, pos_mm, pos_mr)
  pos_fl[is.na(prices)] <- 0

  results_mm <- get_pnl(pos_mm, prices, p_val, tr_cost, add_info = add_info)
  results_mr <- get_pnl(pos_mr, prices, p_val, tr_cost, add_info = add_info)
  results_fl <- get_pnl(pos_fl, prices, p_val, tr_cost, add_info = add_info)

  results_mm <- get_pnl(pos_mm, prices, p_val, tr_cost, add_info = add_info)
  results_mr <- get_pnl(pos_mr, prices, p_val, tr_cost, add_info = add_info)

  results_mm <- get_pnl(pos_mm, prices, p_val, tr_cost, add_info = add_info)
  results_mr <- get_pnl(pos_mr, prices, p_val, tr_cost, add_info = add_info)
  results_fl <- get_pnl(pos_fl, prices, p_val, tr_cost, add_info = add_info)

  if (add_info) {
    result_xts <- cbind(
      prices, pos_flat, slow_m, fast_m, volat_sd,
      pos_mm, pos_mr, pos_fl,
      results_mm$pnl_gross, results_mm$pnl_net, results_mm$n_trans,
      results_mr$pnl_gross, results_mr$pnl_net, results_mr$n_trans,
      results_fl$pnl_gross, results_fl$pnl_net, results_fl$n_trans,
      fill = NA
    )
    colnames(result_xts) <- c(
      "prices", "pos_flat", "slow_m", "fast_m", "volat_sd",
      "pos_mm", "pos_mr", "pos_fl",
      "pnl_gross_mm", "pnl_net_mm", "n_trans_mm",
      "pnl_gross_mr", "pnl_net_mr", "n_trans_mr",
      "pnl_gross_fl", "pnl_net_fl", "n_trans_fl"
    )
    return(result_xts)
  } else {
    stats_mm <- get_statistics(results_mm$daily_pnl_gross,
      results_mm$daily_pnl_net,
      scale = scale_, add_info = add_stats
    )
    stats_mr <- get_statistics(results_mr$daily_pnl_gross,
      results_mr$daily_pnl_net,
      scale = scale_, add_info = add_stats
    )
    stats_fl <- get_statistics(results_fl$daily_pnl_gross,
      results_fl$daily_pnl_net,
      scale = scale_, add_info = add_stats
    )
    return(cbind(stats_mm, stats_mr, stats_fl))
  }
}
```

### Run_strat_ma

```{r, echo = F, warning = F, message = F}
source("helpers/strategies.R")
params <- read.csv("results/Moving_Average_Strategy/last_params.csv")

fast_ma <- params$fast_ma
ma_diff <- params$ma_diff
slow_ma <- fast_ma + ma_diff
signal_estimator <- params$signal_estimator
window_regime <- params$window_regime
treshold_regime <- params$treshold_regime
instrument_name <- params$instrument_name
group_data <- params$group_data
p_val <- params$p_val
tr_cost <- params$tr_cost
res_all <- c()

data_path <- paste0("Dataset",group_data)
data_files <- list.files(data_path)

for (file in data_files) {

  filename_ <- paste0(data_path, "/", file)
  load(filename_)
  r_data_name <- gsub(".RData","",file)
  data <- get(r_data_name)
  res_short <- get_pnl_ma(
    prices = data[, c(instrument_name)],
    group = group_data,
    slow_param = slow_ma,
    fast_param = fast_ma,
    p_val = p_val,
    tr_cost = tr_cost,
    signal_estimator = signal_estimator,
    window_regime = window_regime,
    treshold_regime = treshold_regime
  )
  rm(data)
  gc()
  selected_quarter <- gsub(paste0("data",group_data,"_"),"",r_data_name)
  res_short <- cbind(selected_quarter, params, res_short)
  res_all <- rbind(res_all, res_short)
}
res_all
write.table(res_all,
  file = "results/Moving_Average_Strategy/results.csv", sep = ",",
  col.names = !file.exists("results/Moving_Average_Strategy/results.csv"),
  append = TRUE, row.names = FALSE
)

```

### Run_strat_vb

```{r, echo = F, warning = F, message = F}
source("helpers/strategies.R")
params <- read.csv("results/Volatility_Breakout_Strategy/last_params.csv")

fast_ma <- params$fast_ma
ma_diff <- params$ma_diff
slow_ma <- fast_ma + ma_diff
signal_estimator <- params$signal_estimator
window_regime <- params$window_regime
treshold_regime <- params$treshold_regime
instrument_name <- params$instrument_name
group_data <- params$group_data
volat_param <- params$volat_param
m_ <- params$m_
p_val <- params$p_val
tr_cost <- params$tr_cost
res_all <- c()

data_path <- paste0("Dataset",group_data)
data_files <- list.files(data_path)

for (file in data_files) {

  filename_ <- paste0(data_path, "/", file)
  load(filename_)
  r_data_name <- gsub(".RData","",file)
  data <- get(r_data_name)
  res_short <- get_pnl_vb(
    prices = data[, c(instrument_name)],
    group = group_data,
    slow_param = slow_ma,
    fast_param = fast_ma,
    volat_param = volat_param,
    m_ = m_,
    p_val = p_val,
    tr_cost = tr_cost,
    signal_estimator = signal_estimator,
    window_regime = window_regime,
    treshold_regime = treshold_regime
  )
  rm(data)
  gc()
  selected_quarter <- gsub(paste0("data",group_data,"_"),"",r_data_name)
  res_short <- cbind(selected_quarter, params, res_short)
  res_all <- rbind(res_all, res_short)
}
res_all
write.table(res_all,
  file = "results/Volatility_Breakout_Strategy/results.csv", sep = ",",
  col.names = !file.exists("results/Volatility_Breakout_Strategy/results.csv"),
  append = TRUE, row.names = FALSE
)

```

### Run_strat_2vb

```{r, echo = F, warning = F, message = F}
source("helpers/strategies.R")
params <- read.csv("results/Volatility_Breakout_Double_Strategy/last_params.csv")

params

fast_ma <- params$fast_ma
ma_diff <- params$ma_diff
slow_ma <- fast_ma + ma_diff
signal_estimator <- params$signal_estimator
window_regime <- params$window_regime
treshold_regime <- params$treshold_regime
instrument_name <- params$instrument_name
group_data <- params$group_data
volat_param <- params$volat_param
m_exit <- params$m_exit
m_diff <- params$m_diff
m_entry <- m_exit + m_diff
p_val <- params$p_val
tr_cost <- params$tr_cost

res_all <- c()

data_path <- paste0("Dataset",group_data)
data_files <- list.files(data_path)

for (file in data_files) {

  filename_ <- paste0(data_path, "/", file)
  load(filename_)
  r_data_name <- gsub(".RData","",file)
  data <- get(r_data_name)
  res_short <- get_pnl_2vb(
    prices = data[, c(instrument_name)],
    group = group_data,
    slow_param = slow_ma,
    fast_param = fast_ma,
    volat_param = volat_param,
    m_entry = m_entry,
    m_exit = m_exit,
    p_val = p_val,
    tr_cost = tr_cost,
    signal_estimator = signal_estimator,
    window_regime = window_regime,
    treshold_regime = treshold_regime
  )
  rm(data)
  gc()
  selected_quarter <- gsub(paste0("data",group_data,"_"),"",r_data_name)
  res_short <- cbind(selected_quarter, params, res_short)
  res_all <- rbind(res_all, res_short)
}
write.table(res_all,
  file = "results/Volatility_Breakout_Double_Strategy/results.csv", sep = ",",
  col.names = !file.exists("results/Volatility_Breakout_Double_Strategy/results.csv"),
  append = TRUE, row.names = FALSE
)
```

## Approaches undertaken

This part should describe **in short** what particular methods you used, all entry/exit techniques considered, all additional assumptions.

For **each group of assets separately** You should also explain **WHAT different parameters** you considered (e.g. memories of moving averages, types of moving averages, types of volatility measures, memory of volatility measures, types of additional indicators, memories of additional indicators, etc.), what (if any) additional filtering rules you applied.

You should also explain with details **HOW** you searched for the best combination of parameters for a particular group of assets.

## Finally selected strategy for **group 1**

Provide a **general summary** (approach and a set of **final parameters**) for assets from **group 1**. (e.g. momentum strategy, cross over of two exponential moving averages EMA10 and EMA60).

```{=html}
<!-- here you can include code chunk that applies the strategy for group 1 and calculates all the summary statistics
-->
```
```{r, echo = F, warning = F, message = F}
# here you can refer to the R codes that apply the strategy
# for asset group 1 to all quarters (in a loop)

source("apply_my_strategy_group1.R")
```

## Summary of results for **group 1**

```{r, echo = F}
names(quarter_stats.all.group1)[5] <- "av.ntrades"
column_spec(
kable_styling(kable(quarter_stats.all.group1[, -2], 
                    "html", 
                    digits = 2,
                    align = "r"),
             font_size = 20),
1:7, width = "30em")

# more options here:
# https://haozhu233.github.io/kableExtra/awesome_table_in_html.html
```

your comments required !!!

## PnL of results for **group 1** -- quarter 2022Q1

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group1_2022_Q1.png")

```

your comments required !!!

## PnL of results for **group 1** -- quarter 2022Q3

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group1_2022_Q3.png")

```

your comments required !!!

## PnL of results for **group 1** -- quarter 2022Q4

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group1_2022_Q4.png")

```

your comments required !!!

## PnL of results for **group 1** -- quarter 2023Q2

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group1_2023_Q2.png")

```

your comments required !!!

## PnL of results for **group 1** -- quarter 2023Q4

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group1_2023_Q4.png")

```

your comments required !!!

## PnL of results for **group 1** -- quarter 2024Q1

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group1_2024_Q1.png")

```

your comments required !!!

## PnL of results for **group 1** -- quarter 2024Q2

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group1_2024_Q2.png")

```

your comments required !!!

## Finally selected strategy for **group 2**

Provide a **general summary** (approach and a set of **final parameters**) for assets from **group 2**. (e.g. momentum strategy, cross over of two exponential moving averages EMA10 and EMA60 - if DIFFERENT strategy used for each asset, you should explain EACH separately.).

```{=html}
<!-- here you can include code chunk that applies the strategy for group 1 and calculates all the summary statistics
-->
```
```{r, echo = F, warning = F, message = F}
# here you can refer to the R codes that apply the strategy
# for asset group 2 to all quarters (in a loop)

source("apply_my_strategy_group2.R")
```

## Summary of results for **group 2**

```{r, echo = F}
names(quarter_stats.all.group2)[5] <- "av.ntrades"
column_spec(
kable_styling(kable(quarter_stats.all.group2[, -2], 
                    "html", 
                    digits = 2,
                    align = "r"),
             font_size = 20),
1:7, width = "30em")

# more options here:
# https://haozhu233.github.io/kableExtra/awesome_table_in_html.html
```

your comments required !!!

## PnL of results for **group 2** -- quarter 2022Q1

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group2_2022_Q1.png")

```

your comments required !!!

## PnL of results for **group 2** -- quarter 2022Q3

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group2_2022_Q3.png")

```

your comments required !!!

## PnL of results for **group 2** -- quarter 2022Q4

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group2_2022_Q4.png")

```

your comments required !!!

## PnL of results for **group 2** -- quarter 2023Q2

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group2_2023_Q2.png")

```

your comments required !!!

## PnL of results for **group 2** -- quarter 2023Q4

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group2_2023_Q4.png")

```

your comments required !!!

## PnL of results for **group 2** -- quarter 2024Q1

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group2_2024_Q1.png")

```

your comments required !!!

## PnL of results for **group 2** -- quarter 2024Q2

```{r, echo = F, out.width ='100%'}
knitr::include_graphics("pnl_group2_2024_Q2.png")

```

your comments required !!!

## Summary and conclusions

Here you should include a summary of obtained results and some conclusions.
